#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <string.h>
#include <ctype.h>
#include <math.h>
#pragma warning(disable : 4996)

enum {
    MAX_INSCRIPTIONS = 50, MAX_CARACTERES = 47, MAX_ROLE = 3, MAX_NOM = 31, MAX_MISSIONS = 500, MAX_RESULTAT = 4,
    MAX_ETAT = 4, MAX_SIGNIFICATION = 38, ID0 = 0, ID1 = 1, ID2 = 2, ID3 = 3, MAX_ALIGNEMENT = 4
};

const char EXIT[] = "exit", ESP[] = " ", OP[] = "OP", AG[] = "AG", IN[] = "IN", INSCRIPTION[] = "inscription",
MISSION[] = "mission", CONSULTATION[] = "consultation", DETAIL[] = "detail", ACCEPTATION[] = "acceptation",
SOUS_TRAITANCE[] = "sous-traitance", RAPPORT[] = "rapport", RECAPITULATIF[] = "recapitulatif";

typedef struct {
    char echec;
    char auteur;
}Couple;

typedef struct {
    char role[MAX_ROLE];
    char nom[MAX_NOM];
}Inscription;

typedef struct {
    unsigned int id_M;
    char nom[MAX_NOM];
    double remun;
    int niveau;
    char etat[MAX_ETAT];
    Couple rapport[MAX_RESULTAT];
}Mission;

typedef struct {
    unsigned int nb_inscrit;
    unsigned int nb_mission;
    Inscription inscriptions[MAX_INSCRIPTIONS];
    Mission missions[MAX_MISSIONS];
}Data;

typedef struct {
    const char signification[MAX_SIGNIFICATION];
    double remun;
}Resultat;


const Resultat resultat[MAX_RESULTAT] = { { "Succes", 0. }, { "Local non accessible", 0. }, { "Pas de signal dans le boitier general", 0.055 }, { "Recepteur defectueux", 0.04 } };

void separer(char commande[], Data* data);
void estErreur(unsigned int n);
void affiche(const unsigned int id, const char* nom_mission, const char* nom_entreprise, const double remun, const int niveau, const unsigned int* align);
void alignement(unsigned int index, unsigned int* id_taille, unsigned int* nom_taille, unsigned int* ent_taille, unsigned int* remun_taille, const Data* data);
void estInscription(char* role, char* nom, Data* data);
void estMission(unsigned int id, char* nom, double remun, Data* data);
void attribMission(unsigned int id, char* nom, double remun, Data* data);
void estConsultation(const Data* data);
void estDetail(unsigned int id, Data* data);
void estAcceptation(unsigned int id_op, unsigned int id_mission, Data* data);
void estSoustraitance(unsigned int id_ag, unsigned int id_mission, double remun, Data* data);
void soustraitance(unsigned int id_ag, unsigned int id_mission, double remun, Data* data);
void estRapport(unsigned int id_mission, unsigned int code, Data* data);
void attribRapport(unsigned int id_mission, unsigned int code, Data* data);
void recapitulatif(unsigned int id_ent, Data* data);
void non_attribuee(unsigned int id_ent, unsigned int* align, Data* data);
void attribuee(unsigned int id_ent, unsigned int* align, Data* data);
void terminees(unsigned int id_ent, unsigned int* align, Data* data);
void a_realiser(unsigned int id_ent, unsigned int* align, Data* data);
void realisees(unsigned int id_ent, unsigned int* align, Data* data);


int main() {
    Data data;
    data.nb_inscrit = 0;
    data.nb_mission = 0;

    char commande[MAX_CARACTERES];
    bool test = true;

    while (test) {
        fgets(commande, MAX_CARACTERES, stdin);

        // Supprime le caractère de saut de ligne s'il est présent
        size_t len = strlen(commande);
        if (len > 0 && commande[len - 1] == '\n') {
            commande[len - 1] = '\0';
        }

        if (strcmp(commande, EXIT) == 0) {
            test = false;
        }
        else {
            separer(commande, &data);
        }
    }
    return 0;
}

void separer(char commande[], Data* data) {
    char* temp = strtok(commande, ESP);

    if (temp == NULL)
        return;

    else if (data->nb_inscrit < 50 && strcmp(temp, INSCRIPTION) == 0) {
        temp = strtok(NULL, ESP);
        estInscription(temp, strtok(NULL, ESP), data);
    }

    else if (data->nb_mission < 500 && strcmp(temp, MISSION) == 0) {
        temp = strtok(NULL, ESP);
        char* temp2 = strtok(NULL, ESP);
        estMission(atoi(temp), temp2, atof(strtok(NULL, ESP)), data);
    }
    else if (strcmp(temp, CONSULTATION) == 0) {
        estConsultation(data);
    }
    else if (strcmp(temp, DETAIL) == 0) {
        temp = strtok(NULL, ESP);
        estDetail(atoi(temp), data);
    }
    else if (strcmp(temp, ACCEPTATION) == 0) {
        temp = strtok(NULL, ESP);
        estAcceptation(atoi(temp), atoi(strtok(NULL, ESP)), data);
    }
    else if (strcmp(temp, SOUS_TRAITANCE) == 0) {
        temp = strtok(NULL, ESP);
        char* temp2 = strtok(NULL, ESP);
        estSoustraitance(atoi(temp), atoi(temp2), atof(strtok(NULL, ESP)), data);
    }
    else if (strcmp(temp, RAPPORT) == 0) {
        temp = strtok(NULL, ESP);
        estRapport(atoi(temp), atoi(strtok(NULL, ESP)), data);
    }
    else if (strcmp(temp, RECAPITULATIF) == 0) {
        recapitulatif(atoi(strtok(NULL, ESP)), data);
    }
}

void estErreur(unsigned int n) {
    switch (n)
    {
    case 0:
        printf("Role incorrect\n");
        break;
    case 1:
        printf("Nom incorrect\n");
        break;
    case 2:
        printf("Identifiant incorrect\n");
        break;
    case 3:
        printf("Aucune mission disponible\n");
        break;
    case 4:
        printf("Mission incorrecte\n");
        break;
    case 5:
        printf("Entreprise incorrecte\n");
        break;
    case 6:
        printf("Remuneration incorrecte\n");
        break;
    case 7:
        printf("Code de retour incorrect\n");
        break;
    default:
        break;
    }
}

void affiche(const unsigned int id, const char* nom_mission, const char* nom_entreprise, const double remun, const int niveau, const unsigned int* align) {
    printf("%-*u %-*s %-*s %*.2f (%d)\n", align[ID0], id, align[ID1], nom_mission, align[ID2], nom_entreprise, align[ID3], remun, niveau);
}

void alignement(unsigned int index, unsigned int* id_taille, unsigned int* nom_taille, unsigned int* ent_taille, unsigned int* remun_taille, const Data* data) {
    unsigned int id_temp = data->missions[index].id_M, id_temp_taille = 0, remun_temp_taille = 0;
    double remun_temp = data->missions[index].remun;

    while (id_temp > 0) {
        id_temp /= 10;
        ++id_temp_taille;
    }
    while (remun_temp >= 0.001) {
        remun_temp /= 10.;
        ++remun_temp_taille;
    }
    if (id_temp_taille > *id_taille)
        *id_taille = id_temp_taille;
    if (remun_temp_taille > *remun_taille)
        *remun_taille = remun_temp_taille;
    if (strlen(data->missions[index].nom) > *nom_taille)
        *nom_taille = strlen(data->missions[index].nom);
    if (strlen(data->inscriptions[data->missions[index].etat[ID1] - 1].nom) > *ent_taille)
        *ent_taille = strlen(data->inscriptions[data->missions[index].etat[ID1] - 1].nom);

}

void estInscription(char* role, char* nom, Data* data) {
    bool test_nom = true;
    if (strcmp(role, OP) == 0 || strcmp(role, AG) == 0 || strcmp(role, IN) == 0) {
        for (int i = 0; i != data->nb_inscrit; ++i) {
            if (strcmp(data->inscriptions[i].nom, nom) == 0) {
                printf("%s\t%s\n", data->inscriptions[i].nom, nom);
                test_nom = false;
            }
        }
        if (test_nom) {
            strcpy(data->inscriptions[data->nb_inscrit].role, role);
            strcpy(data->inscriptions[data->nb_inscrit].nom, nom);
            ++data->nb_inscrit;
            printf("Inscription realisee (%d)\n", data->nb_inscrit);
        }
        else {
            estErreur(1);
        }
    }
    else {
        estErreur(0);
    }
}

void estMission(unsigned int id, char* nom, double remun, Data* data) {
    if (id > 0 && strcmp(data->inscriptions[id - 1].role, OP) == 0) {
        if (remun > 0.) {
            attribMission(id, nom, remun, data);
            printf("Mission publiee (%d)\n", data->nb_mission);
        }
        else
            estErreur(6);
    }
    else
        estErreur(2);
}

void attribMission(unsigned int id, char* nom, double remun, Data* data) {
    data->missions[data->nb_mission].remun = remun;
    data->missions[data->nb_mission].niveau = 0;
    data->missions[data->nb_mission].etat[ID0] = -1;
    data->missions[data->nb_mission].etat[ID1] = id;
    data->missions[data->nb_mission].etat[ID2] = 0;
    data->missions[data->nb_mission].etat[ID3] = -1;
    data->missions[data->nb_mission].id_M = data->nb_mission;
    strcpy(data->missions[data->nb_mission].nom, nom);
    for (int i = 0; i != MAX_RESULTAT; ++i) {
        data->missions[data->nb_mission].rapport[i].auteur = -1;
        data->missions[data->nb_mission].rapport[i].echec = -1;
    }
    ++data->nb_mission;
}

void estConsultation(const Data* data) {
    bool test = false;
    unsigned int align[MAX_ALIGNEMENT] = { 0 };
    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].etat[ID0] == -1) {
            alignement(i, &align[ID0], &align[ID1], &align[ID2], &align[3], data);
        }
    }

    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].etat[ID0] == -1) {
            affiche(i + 1, data->missions[i].nom, data->inscriptions[data->missions[i].etat[ID1] - 1].nom, data->missions[i].remun, data->missions[i].niveau, align);
            test = true;
        }
    }

    if (!test)
        estErreur(3);
}

void estDetail(unsigned int id, Data* data) {
    if (data->missions[id - 1].etat[ID0] == -1) {
        unsigned int align[MAX_ALIGNEMENT] = { 0 };
        alignement(id - 1, &align[ID0], &align[ID1], &align[ID2], &align[ID3], data);
        affiche(id, data->missions[id - 1].nom, data->inscriptions[data->missions[id - 1].etat[ID1] - 1].nom, data->missions[id - 1].remun, data->missions[id - 1].niveau, align);
        for (int i = 0; i != MAX_RESULTAT; ++i) {
            if (data->missions[id - 1].rapport[i].echec != -1)
                printf("%s\n", resultat[data->missions[id - 1].rapport[i].echec].signification);
        }
    }
    else
        estErreur(2);
}

void estAcceptation(unsigned int id_op, unsigned int id_mission, Data* data) {
    bool test = true;

    for (int i = 0; i != MAX_RESULTAT; ++i) {
        if (id_mission > 0 && data->missions[id_mission - 1].rapport[i].auteur == id_op)
            test = false;
    }

    if (id_op > 0 && test && strcmp(data->inscriptions[id_op - 1].role, OP) != 0) {
        if (id_mission > 0 && data->missions[id_mission - 1].etat[ID0] == -1) {
            data->missions[id_mission - 1].etat[ID0] = id_op;
            data->missions[id_mission - 1].etat[ID3] = id_op;
            printf("Acceptation enregistree\n");
        }
        else
            estErreur(4);
    }
    else
        estErreur(5);
}

void estSoustraitance(unsigned int id_ag, unsigned int id_mission, double remun, Data* data) {
    if (id_ag > 0 && strcmp(data->inscriptions[id_ag - 1].role, AG) == 0) {
        if (id_mission > 0 && (data->missions[id_mission - 1].etat[ID0] == -1 && data->missions[id_mission - 1].niveau < 5)) {
            if (remun > 0.) {
                soustraitance(id_ag, id_mission, remun, data);
                printf("Sous-traitance enregistree (%u)\n", data->nb_mission);
            }
            else
                estErreur(6);
        }
        else
            estErreur(4);
    }
    else
        estErreur(5);
}

void soustraitance(unsigned int id_ag, unsigned int id_mission, double remun, Data* data) {
    unsigned int id_temp = data->missions[id_mission - 1].id_M;
    data->missions[id_mission - 1].etat[ID0] = id_ag;

    attribMission(id_ag, data->missions[id_mission - 1].nom, remun, data);
    data->missions[data->nb_mission - 1].niveau = data->missions[id_mission - 1].niveau + 1;
    data->missions[data->nb_mission - 1].id_M = id_temp;
    for (int i = 0; i != MAX_RESULTAT; ++i)
        data->missions[data->nb_mission - 1].rapport[i].echec = data->missions[id_mission - 1].rapport[i].echec;
}

void estRapport(unsigned int id_mission, unsigned int code, Data* data) {
    bool test = true;
    if (id_mission <= 0 || id_mission > data->nb_mission)
        estErreur(4);
    else {
        for (int i = id_mission; i != data->nb_mission; ++i) {
            if (data->missions[i].id_M == data->missions[id_mission - 1].id_M && data->missions[i].niveau > data->missions[id_mission - 1].niveau && test) {
                estErreur(4);
                test = false;
            }
        }
        if (test)
            (code >= 0 && code <= 3) ? attribRapport(id_mission, code, data) : estErreur(7);
    }
}


void attribRapport(unsigned int id_mission, unsigned int code, Data* data) {
    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].id_M == data->missions[id_mission - 1].id_M)
            data->missions[i].etat[ID2] = 1;
    }

    if (code == 0)
        printf("Rapport enregistre\n");

    else {
        double remun = data->missions[id_mission - 1].remun + (data->missions[id_mission - 1].remun * resultat[code].remun);
        int id_temp = data->nb_mission;
        Couple rapport_temp[MAX_RESULTAT];

        for (int i = 0; i != MAX_RESULTAT - 1; ++i) {
            rapport_temp[i + 1] = data->missions[id_mission - 1].rapport[i];
        }
        rapport_temp[0].auteur = data->missions[id_mission - 1].etat[ID3];
        rapport_temp[0].echec = code;

        attribMission(data->missions[id_mission - 1].etat[ID1], data->missions[id_mission - 1].nom, remun, data);

        for (int i = 0; i != MAX_RESULTAT; ++i) {
            data->missions[id_temp].rapport[i] = rapport_temp[i];
        }

        printf("Rapport enregistre (%d)\n", data->nb_mission);
    }
}

void recapitulatif(unsigned int id_ent, Data* data) {
    if (id_ent > 0 && ((strcmp(data->inscriptions[id_ent - 1].role, OP) == 0) || (strcmp(data->inscriptions[id_ent - 1].role, AG) == 0) || (strcmp(data->inscriptions[id_ent - 1].role, IN) == 0))) {
        bool non_attrib = false, attrib = false, termine = false, a_real = false, real = false;
        unsigned int align[MAX_ALIGNEMENT] = { 0 };

        for (int i = 0; i != data->nb_mission; ++i) {
            if (data->missions[i].etat[ID1] == id_ent && data->missions[i].etat[ID0] == -1) {
                alignement(i, &align[ID0], &align[ID1], &align[ID2], &align[ID3], data);
                non_attrib = true;
            }
            if (data->missions[i].etat[ID1] == id_ent && data->missions[i].etat[ID0] != -1 && data->missions[i].etat[ID0] != id_ent && !data->missions[i].etat[ID2]) {
                alignement(i, &align[ID0], &align[ID1], &align[ID2], &align[ID3], data);
                attrib = true;
            }
            if (data->missions[i].etat[ID1] == id_ent && data->missions[i].etat[ID2]) {
                alignement(i, &align[ID0], &align[ID1], &align[ID2], &align[ID3], data);
                termine = true;
            }
            if (data->missions[i].etat[ID3] == id_ent && !data->missions[i].etat[ID2]) {
                alignement(i, &align[ID0], &align[ID1], &align[ID2], &align[ID3], data);
                a_real = true;
            }
            if (data->missions[i].etat[ID3] == id_ent && data->missions[i].etat[ID2]) {
                alignement(i, &align[ID0], &align[ID1], &align[ID2], &align[ID3], data);
                real = true;
            }
        }
        if (non_attrib)
            non_attribuee(id_ent, align, data);
        if (attrib)
            attribuee(id_ent, align, data);
        if (termine)
            terminees(id_ent, align, data);
        if (a_real)
            a_realiser(id_ent, align, data);
        if (real)
            realisees(id_ent, align, data);
    }

    else
        estErreur(5);
}

void non_attribuee(unsigned int id_ent, unsigned int* align, Data* data) {
    printf("* non attribuees\n");
    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].etat[ID1] == id_ent && data->missions[i].etat[ID0] == -1) {
            printf("%s%s", ESP, ESP);
            affiche(i + 1, data->missions[i].nom, data->inscriptions[data->missions[i].etat[1] - 1].nom, data->missions[i].remun, data->missions[i].niveau, align);
        }
    }
}

void attribuee(unsigned int id_ent, unsigned int* align, Data* data) {
    printf("* attribuees\n");
    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].etat[ID1] == id_ent && data->missions[i].etat[ID0] != -1 && data->missions[i].etat[ID0] != id_ent && !data->missions[i].etat[ID2]) {
            printf("%s%s", ESP, ESP);
            affiche(i + 1, data->missions[i].nom, data->inscriptions[data->missions[i].etat[1] - 1].nom, data->missions[i].remun, data->missions[i].niveau, align);
        }
    }
}

void terminees(unsigned int id_ent, unsigned int* align, Data* data) {
    printf("* terminees\n");
    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].etat[ID1] == id_ent && data->missions[i].etat[ID2]) {
            printf("%s%s", ESP, ESP);
            affiche(i + 1, data->missions[i].nom, data->inscriptions[data->missions[i].etat[1] - 1].nom, data->missions[i].remun, data->missions[i].niveau, align);
        }
    }
}

void a_realiser(unsigned int id_ent, unsigned int* align, Data* data) {
    printf("* a realiser\n");
    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].etat[ID3] == id_ent && !data->missions[i].etat[ID2]) {
            printf("%s%s", ESP, ESP);
            affiche(i + 1, data->missions[i].nom, data->inscriptions[data->missions[i].etat[1] - 1].nom, data->missions[i].remun, data->missions[i].niveau, align);
        }
    }
}

void realisees(unsigned int id_ent, unsigned int* align, Data* data) {
    printf("* realisees\n");
    for (int i = 0; i != data->nb_mission; ++i) {
        if (data->missions[i].etat[ID3] == id_ent && data->missions[i].etat[ID2]) {
            printf("%s%s", ESP, ESP);
            affiche(i + 1, data->missions[i].nom, data->inscriptions[data->missions[i].etat[1] - 1].nom, data->missions[i].remun, data->missions[i].niveau, align);
        }
    }
}
